# NEP89模型微调教程
  此教程包含如何获取NEP89模型、核心优势、以及**使用方法**。
## 引言
  NEP89模型是基于神经演化势架构的基础模型，涵盖元素周期表中89种元素的机器学习势（MLP），受到广泛关注[**NEP89**

尽管NEP89模型可能达不到很高的精度，但数据集非常丰富，涵盖无机和有机材料。与代表性的基础模型相比，计算速度比同类模型快1000倍以上，在计算精度上也具有一定竞争力，且在单GPU上模拟1500万个原子，支持大规模分子动力学模拟。精度高、数据广、计算快、使用简单。  
以下以计算石墨烯热导率为例，介绍NEP89模型的使用方法。

##	NEP89的使用方法
### 获取NE89模型
NEP89模型包含在GPUMD软件包中。nep89文件夹下包含三个文件：  
nep89_20250409.txt：NEP89模型文件。  
nep.in和nep89_20250409.restart：用于微调。
### 开箱即用：计算石墨烯热导率
直接使用NEP89模型计算单层石墨烯热导率，以下提供了石墨烯的model.xyz文件（石墨烯为二维材料，周期性边界条件设置为pbc="T T F"。

本教程使用the Homogeneous Non-Equilibrium Molecular Dynamics（HNEMD）方法计算热导率，run.in文件示例如下：
```
potential    ./nep89_20250409.txt
velocity     300

ensemble     nvt_nhc 300 300 100
time_step    1       
run          1000000

ensemble      nvt_nhc 300 300 100
compute_hnemd 1000 0 0.00001 0
compute_shc   2 250 1 1000 400 group 0 0
run           10000000
```

建议进行多次独立的HNEMD模拟获得标准误差。
在此教程中只进行了一次HNEMD模拟（后续补充计算），模拟结果见下图。这一结果与实验值存在显著偏差，表明NEP89模型的开箱即用在无需额外微调的情况下，用于计算石墨烯的热导率并不理想。

![hnemd.png](C:\Users\wanggang\Desktop\Git_hub\nep89_fine_tune\1_C_hnemd\1\hnemd.png "hnemd.png")
### 利用NEP89模型生成微调训练集

为提高准确性，可以使用一小部分密度泛函理论计算（DFT）对NEP89进行微调，以生成专为石墨烯定制的构型
建议读者使用NEP89模型及GPUMD程序进行分子动力学模拟，输出原子轨迹。

此案例中，我们关注的是300K时石墨烯的热导率。因此我们建议在300K下进行NPT或NVT模拟。

下面给出一个run.in示例：
~~~
potential    ./nep89_20250409.txt
velocity     300

ensemble     nvt_ber 300 300 100
time_step    1 
dump_thermo  3000
dump_position 3000      
run          3000000
~~~

在此，我们进行了3纳秒的NVT模拟,并每3皮秒对构型进行一次采样,共得到1000帧。

需要注意的是，采样的构型须用于单点密度泛函理论（DFT）计算，以获得能量、力和应力等物理量完善train.xyz。因此，分子动力学（MD）采样的原子数不应过多，以确保密度泛函理论计算可行。

为了获得更好的样本，建议进行至少两次独立的随机分子动力学模拟。本案例只进行了一次随机分子动力学模拟（后续补充计算），然后应用了最远点采样（FPS）以获得部分代表性结构。

此案例中FPS程序使用脚本 **select_pick_structure.py** 执行（此处感谢**唐本瑞**同学贡献的脚本）  
当然，也有许多其他工具达到同样的目的，如 **nep-select-fps.py**   

### 密度泛函理论的单点计算

获得结构后，可以进行单点密度泛函理论计算。  
此过程还需要将MD的轨迹输出文件**dump.xyz**或者**movie.xyz**转换为用于DFT单点计算的**POSCAR**。  
可参考**唐同学**的脚本**dumpxyz2POSCAR.py** 实现以上操作。 (该脚本会自动生成KPONINTS文件，如需修改，请关闭或替换)。  
>- 在此案例中使用了VASP。下面展示VASP的INCAR文件示例参考：
```
Global Parameters
ISTART =  0            (Not Read existing wavefunction; if there)
ISPIN  =  1            (Non-Spin polarised DFT, Default=1)

ICHARG =  2            (The initial guess charge density is generated by superposition of atomic charge density)
LREAL  =  Auto         (Projection operators: automatic)
ENCUT  =  500          (Cut-off energy for plane wave basis set, in eV)

LWAVE  = .FALSE.       (Write WAVECAR or not)
LCHARG = .FALSE.       (Write CHGCAR or not)

PREC     =  Accurate   (Precision level)
KGAMMA   = .TRUE.      # GAMMA point
ALGO     = Normal

Static Calculation
NSW    =   0           (Default: NSW = 0)
IBRION =  -1           (Ions are not moved)
ISMEAR =  0           

EDIFF  =  1E-06        (SCF energy convergence; in eV)

NELM   =  150          (Max electronic SCF steps)
```
>- 对于单层石墨烯KPONINTS文件示例参考：
```
K-Points
0
Monkhorst-Pack
15 15 1
0 0 0
```
VASP参数选择读者参考**VASP手册**  
批量提交VASP作业可参考.sh脚本**vasp_run.sh**

---
完成单点计算后，我们使用vasp2nep.py来提取能量、力、位力数据并输出为train.xyz  
类似工具可以在**GPUMD**仓库中**tools**内找到。  
在**vasp2nep.py**中，读者只需要修改以下几行：  
```
path = './train_folders'
include_virial = True
include_VDW = False

```
该脚本将遍历给定文件夹内的所有OUTCAR文件，并输出一个合并的**train.xyz**
## 微调NEP89模型
### 微调前先预测
微调之前，先用NEP89模型**预测**是非常有必要的。  
下面给出一个预测的nep.in文件示例：
```
type       89 H He Li Be B C N O F Ne Na Mg Al Si P S Cl Ar K Ca Sc Ti V Cr Mn Fe Co Ni Cu Zn Ga Ge As Se Br Kr Rb Sr Y Zr Nb Mo Tc Ru Rh Pd Ag Cd In Sn Sb Te I Xe Cs Ba La Ce Pr Nd Pm Sm Eu Gd Tb Dy Ho Er Tm Yb Lu Hf Ta W Re Os Ir Pt Au Hg Tl Pb Bi Ac Th Pa U Np Pu 
version    4
zbl        2
cutoff     6 5
n_max      4 4
basis_size 8 8
l_max      4 2 1
neuron     80
lambda_1   0
lambda_e   1
lambda_f   1
lambda_v   1
batch      5000
prediction 1
population 10
generation 1000
```
与标准的**nep.in**文件相比，增加了**prediction 1**用于启用GPUMD的预测功能。  
脚本**Plot_prediction.py**可将预测结果可视化。  
 ![prediction](C:\Users\wanggang\Desktop\Git_hub\nep89_fine_tune\4_prediction\prediction.png)

预测结果存在一定程度偏差，这一问题可通过微调得到有效解决。
### 开始微调
接下来演示如何使用准备好的**train.xyz**进行NEP89微调  
下面给出一个用于微调的nep.in文件示例：  
```
# for prediction
#type       89 H He Li Be B C N O F Ne Na Mg Al Si P S Cl Ar K Ca Sc Ti V Cr Mn Fe Co Ni Cu Zn Ga Ge As Se Br Kr Rb Sr Y Zr Nb Mo Tc Ru Rh Pd Ag Cd In Sn Sb Te I Xe Cs Ba La Ce Pr Nd Pm Sm Eu Gd Tb Dy Ho Er Tm Yb Lu Hf Ta W Re Os Ir Pt Au Hg Tl Pb Bi Ac Th Pa U Np Pu 
#prediction 1

# for fine-tuning
fine_tune  nep89_20250409.txt nep89_20250409.restart
type       1  C
# These cannot be changed:
version    4
zbl        2
cutoff     6 5
n_max      4 4
basis_size 8 8
l_max      4 2 1
neuron     80

# These can be changed:
lambda_1   0
lambda_e   1
lambda_f   1
lambda_v   1
batch      5000
population 50
save_potential 2000 1 1
generation 20000
```
建议读者查阅GPUMD手册中关于fine_tune以及save_potential命令的内容。  
[**type**]()：训练/微调数据集中包含的数字和化学元素列表。如果您的系统有其他元素，请相应修改此行。  
[**These can be changed:**]()以下部分为可修改参数，由用户自定义，以满足特定要求。  
[**save_potential 2000 1 1**]()：每2000步输出一个更新后的势能模型。参考**save_potential**命令。  
[**generation 20000**]()：我们总共执行了20000次微调。

>- 更大的微调数据集通常需要更多的步骤
>- 避免过度微调  
微调后，使用脚本**plot_RMSE.py**可视化均方根误差（RMSE）的变化  
 以下给出微调5000步和20000步的变化  
**5000步：**  
![RMSE.png](C:\Users\wanggang\Desktop\Git_hub\nep89_fine_tune\5_fine_tune\fine_tune_5000\RMSE.png)
---
**20000步：**
![RMSE.png](C:\Users\wanggang\Desktop\Git_hub\nep89_fine_tune\5_fine_tune\fine_tune_20000\RMSE.png)  
在获得不同微调步数的势函数模型后，读者可以验证相应的物理性质。  
>- 还可以测试自己系统中**微调步数**与其产生的**物理性质**之间的关系。  
>- 此案例还未测试不同**微调步数**下石墨烯热导率计算值的变化[**后续补充**]() 
## 使用微调模型重新计算石墨烯热导率
在此案例中，经过18000步微调的势函数模型，在石墨烯的热导率计算中与参考值的一致性最佳。  
使用微调后的势函数模型计算石墨烯热导率。（应多次独立计算取平均以减少标准误差）  
以下仅展示微调**18000步**的模型在石墨烯的热导率计算中的平均结果(2次独立计算)：  
**Kappa_y=1701.3141 ± 0.0000 W/mK**  
![hnemd_ave.png](C:\Users\wanggang\Desktop\nep89微调\6_fine_tune_TC\hnemd_ave.png)

>- **对于本教程需要修改和补充的地方，欢迎提出意见！**
>- **此教程所有文件将上传至GitHub**


 